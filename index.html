<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, onValue, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  let app=null, db=null;
  let connectedCasa=false, connectedSensores=false;

  /* ============================================================
        FUNCIÃ“N QUE BLOQUEA / LIBERA BOTONES SEGÃšN EL MODO
     ============================================================ */
  function applyModeUI(mode){
    const isAdmin = (mode === "admin");

    // Lista de botones que NO debe usar el operador
    const adminButtons = [
      "btnAuto","btnManual",
      "btnHeatOn","btnHeatOff",
      "btnCoolOn","btnCoolOff",
      "btnSalaOn","btnSalaOff"
    ];

    adminButtons.forEach(id=>{
      const el=document.getElementById(id);
      if(!el) return;
      if(isAdmin){
        el.classList.remove("btn-disabled");
      } else {
        el.classList.add("btn-disabled");
      }
    });
  }

  /* ============================================================
                      INICIO GRAFICA ECHARTS
     ============================================================ */

  const chart = echarts.init(document.getElementById('chartAvg'));
  const times=[], values=[]; const MAXP=120;

  chart.setOption({
    backgroundColor:'transparent',
    tooltip:{ trigger:'axis' },
    xAxis:{ type:'category', boundaryGap:false, data:times,
      axisLabel:{color:'#9fbcd6'}, axisLine:{show:false} },
    yAxis:{ type:'value', axisLabel:{color:'#9fbcd6'},
      splitLine:{lineStyle:{color:'#0f1720'}} },
    grid:{ left:'6%', right:'6%', top:'8%', bottom:'10%' },
    series:[{
      type:'line', smooth:true, data:values, showSymbol:false,
      lineStyle:{width:3,color:'#7dd3fc'},
      areaStyle:{color:'rgba(125,211,252,0.08)'}
    }]
  });

  function pushAverage(avg){
    const t=new Date().toLocaleTimeString();
    if(times.length>=MAXP){ times.shift(); values.shift(); }
    times.push(t); values.push(Number(avg.toFixed(2)));

    chart.setOption({
      xAxis:{data:times},
      series:[{data:values}]
    });
  }

  /* ============================================================
                  FUNCIÃ“N PARA ACTUALIZAR ORBES
     ============================================================ */
  function updateOrb(index, rawVal){
    const v=(typeof rawVal==='number' && !isNaN(rawVal))?rawVal:NaN;

    const orb=document.getElementById('orb'+index);
    const halo=document.getElementById('halo'+index);
    const valEl=document.getElementById('val'+index);

    if(isNaN(v)){
      valEl.innerText='--';
      orb.style.transform='scale(1)';
      halo.style.opacity='0.12';
      orb.style.background='linear-gradient(180deg,#0b1622,#07121a)';
      halo.style.background='radial-gradient(circle, rgba(80,80,80,0.06), transparent 60%)';
    }
    else {
      valEl.innerText=v.toFixed(2);

      let col;
      if(v<=18) col={bg:'linear-gradient(180deg,#062a47,#022134)',halo:'rgba(43,156,255,0.28)'};
      else if(v<=25) col={bg:'linear-gradient(180deg,#083846,#053238)',halo:'rgba(50,209,201,0.28)'};
      else if(v<=35) col={bg:'linear-gradient(180deg,#3a2c08,#261b06)',halo:'rgba(255,159,28,0.28)'};
      else col={bg:'linear-gradient(180deg,#4c0a06,#2b0503)',halo:'rgba(255,46,46,0.32)'};

      orb.style.background=col.bg;
      halo.style.background=`radial-gradient(circle, ${col.halo}, transparent 60%)`;
      halo.style.opacity=0.9;
      orb.style.transform=`scale(${1+Math.min(0.14,(v-10)/200)})`;
    }
  }

  /* ============================================================
                   INDICADOR DE ESTADO WIFI
     ============================================================ */
  function updateStatusUI(){
    const el=document.getElementById('statusIndicator');
    const ok = connectedCasa || connectedSensores;

    if(ok){
      el.innerText='Conectado';
      el.style.background='rgba(20,160,120,0.06)';
      el.style.color='#7bf0b7';
      el.style.border='1px solid rgba(50,200,140,0.06)';
    } else {
      el.innerText='Desconectado';
      el.style.background='rgba(220,40,40,0.06)';
      el.style.color='#ff7b7b';
      el.style.border='1px solid rgba(255,120,120,0.06)';
    }
  }

  /* ============================================================
                   INICIO FIREBASE Y LISTENERS
     ============================================================ */

  function initFirebase(apiKey, databaseURL, initialAdminPass){
    try{
      app = initializeApp({ apiKey, databaseURL });
      db = getDatabase(app);

      // Crear pass admin si no existe
      (async ()=>{
        const adminRef = ref(db, 'sistema/admin_pass');
        const snap = await get(adminRef);
        if(!snap.exists()) await set(adminRef, initialAdminPass);
      })();

      // CASA
      onValue(ref(db, 'casa'), snap=>{
        connectedCasa=true; updateStatusUI();
      },()=>{ connectedCasa=false; updateStatusUI(); });

      // SENSORES
      onValue(ref(db,'sensores'), snap=>{
        connectedSensores=true; updateStatusUI();
        const data=snap.val(); if(!data) return;

        const arr=[data.t1,data.t2,data.t3,data.t4];
        let valid=[];

        arr.forEach((v,i)=>{
          if(typeof v==='number' && v>-100) { updateOrb(i+1,v); valid.push(v); }
          else updateOrb(i+1,NaN);
        });

        let avg=null;
        if(valid.length>0){
          avg=valid.reduce((a,b)=>a+b,0)/valid.length;
        }

        if(avg!==null){
          document.getElementById('avgNowHeader').innerText=avg.toFixed(2)+' Â°C';
          pushAverage(avg);
        } else {
          document.getElementById('avgNowHeader').innerText='-- Â°C';
        }
      },()=>{ connectedSensores=false; updateStatusUI(); });

      // SISTEMA (MODO / CONTROL)  **AQUÃ SE APLICA applyModeUI**
      onValue(ref(db,'sistema'), snap=>{
        const s=snap.val(); if(!s) return;

        if(s.modo){
          document.getElementById('currentMode').innerText=s.modo.toUpperCase();
          applyModeUI(s.modo);        // ðŸ”¥ ahora sÃ­ se bloquean/activan botones
        }
        if(s.tipoControl){
          document.getElementById('controlTypeLabel').innerText=s.tipoControl.toUpperCase();
        }
      });

      // CONTROL
      onValue(ref(db,'control'), snap=>{
        const c=snap.val(); if(!c) return;
        document.getElementById('statHeat').innerText=c.calentador? "ON":"OFF";
        document.getElementById('statCool').innerText=c.enfriador? "ON":"OFF";
      });

      updateStatusUI();

    }catch(e){
      console.error("initFirebase error",e);
    }
  }

  /* ============================================================
                       BOTON: GUARDAR CONFIG
     ============================================================ */
  document.getElementById('saveConfigBtn').addEventListener('click', ()=>{
    const key=document.getElementById('apiKeyInput').value.trim();
    const url=document.getElementById('dbUrlInput').value.trim();
    const pass=document.getElementById('adminPassInput').value.trim() || "123456VN";

    if(!key||!url){
      return Swal.fire("Error","Faltan datos","error");
    }

    localStorage.setItem('iot_api_key',key);
    localStorage.setItem('iot_db_url',url);

    initFirebase(key,url,pass);
    closeConfig();
  });

  /* ============================================================
                     BOTÃ“N CAMBIAR MODO
     ============================================================ */
  document.getElementById('btnModeToggle').addEventListener('click', async ()=>{
    if(!db) return Swal.fire("Error","Configura Firebase primero","warning");

    const sistemaRef=ref(db,'sistema');
    const snap=await get(sistemaRef);
    const cur=snap.exists()? snap.val().modo : "operador";

    // operador â†’ admin
    if(cur==="operador"){
      const {value:pass}=await Swal.fire({
        title:"ContraseÃ±a Admin",
        input:"password",
        inputPlaceholder:"Ingresa contraseÃ±a",
        showCancelButton:true
      });
      if(!pass) return;

      const passSnap = await get(child(ref(db), 'sistema/admin_pass'));
      if(!passSnap.exists()) return Swal.fire("Error","No hay contraseÃ±a configurada","error");

      if(pass === passSnap.val()){
        await set(ref(db,"sistema/modo"),"admin");
        Swal.fire("OK","Modo ADMIN activado","success");
      } else {
        Swal.fire("Error","ContraseÃ±a incorrecta","error");
      }
    }
    else {
      await set(ref(db,"sistema/modo"),"operador");
      Swal.fire("OK","Modo OPERADOR activado","success");
    }
  });

  /* ============================================================
                      CONTROL TIPO (AUTO / MANUAL)
     ============================================================ */

  document.getElementById('btnAuto').addEventListener('click',()=>{
    if(!db) return; set(ref(db,"sistema/tipoControl"),"auto");
  });

  document.getElementById('btnManual').addEventListener('click',()=>{
    if(!db) return; set(ref(db,"sistema/tipoControl"),"manual");
  });

  /* ============================================================
                       CONTROL MANUAL (CALOR/FRÃO)
     ============================================================ */

  document.getElementById('btnHeatOn').addEventListener('click',()=>{ if(db) set(ref(db,'control/calentador'),true); });
  document.getElementById('btnHeatOff').addEventListener('click',()=>{ if(db) set(ref(db,'control/calentador'),false); });
  document.getElementById('btnCoolOn').addEventListener('click',()=>{ if(db) set(ref(db,'control/enfriador'),true); });
  document.getElementById('btnCoolOff').addEventListener('click',()=>{ if(db) set(ref(db,'control/enfriador'),false); });

  /* ============================================================
                      SALA ON / OFF
     ============================================================ */
  document.getElementById('btnSalaOn').addEventListener('click',()=>{ if(db) set(ref(db,'casa/sala'),true); });
  document.getElementById('btnSalaOff').addEventListener('click',()=>{ if(db) set(ref(db,'casa/sala'),false); });

  /* ============================================================
                      AUTOINICIO FIREBASE
     ============================================================ */
  (function(){
    const key=localStorage.getItem('iot_api_key');
    const url=localStorage.getItem('iot_db_url');

    if(key && url){
      document.getElementById('apiKeyInput').value=key;
      document.getElementById('dbUrlInput').value=url;
      initFirebase(key,url,"123456VN");
    } else {
      setTimeout(()=>openConfig(),800);
    }
  })();

  window.openConfig = ()=>document.getElementById('configModal').classList.remove("hidden");
  window.closeConfig = ()=>document.getElementById('configModal').classList.add("hidden");

</script>
